# Ifthenpay MB WAY Integration: Backend API Requirements

This document outlines the backend API endpoints required to integrate MB WAY payments using Ifthenpay.

## 1. Initiate Payment Request

This endpoint is called by the frontend when the user decides to pay with MB WAY.

*   **URL:** `/api/ifthenpay/initiate-payment`
*   **Method:** `POST`
*   **Request Body:**
    ```json
    {
      "bookingDetails": { // Optional, for your backend's reference
        "serviceName": "string",
        "selectedDate": "string (ISO 8601 DateTime)",
        "clientName": "string",
        "clientEmail": "string",
        "clientPhone": "string (optional)"
      },
      "mbwayPhoneNumber": "string", // User's MB WAY phone number (e.g., "9XXXXXXXX")
      "orderId": "string",          // Unique order/transaction ID generated by the frontend/backend
      "amount": "string"            // Payment amount (e.g., "120.00")
    }
    ```
*   **Backend Logic:**
    1.  Validate the incoming request data (e.g., ensure `mbwayPhoneNumber`, `orderId`, `amount` are present and valid).
    2.  Retrieve your Ifthenpay MB WAY Key (this should be stored securely as a server-side configuration/environment variable).
    3.  Construct the request to Ifthenpay's API endpoint for initiating an MB WAY payment. According to Ifthenpay documentation, this typically involves parameters like:
        *   `MbWayKey`: Your Ifthenpay MB WAY Key.
        *   `orderid`: Your unique `orderId`.
        *   `valor`: The `amount`.
        *   `nrtlm`: The `mbwayPhoneNumber`.
        *   `email`: (Optional) Client's email.
        *   `descricao`: (Optional) Description for the payment.
    4.  Make a POST request to the Ifthenpay API endpoint (e.g., `https://mb.ifthenpay.com/IfthenPayMBW.asmx/SetPedidoJSON`).
    5.  Store the `orderId` and initial transaction details (e.g., status "pending") in your database.
    6.  Return Ifthenpay's direct response to the frontend.
*   **Success Response (Example from Ifthenpay):**
    ```json
    {
      "IdPedido": "your_order_id_echoed_back", // Or Ifthenpay's internal ID for the request
      "Status": "0", // "0" usually indicates success in initiating
      "Msg": "Success" // Or other message from Ifthenpay
    }
    ```
*   **Error Response:**
    ```json
    {
      "error": true,
      "message": "Descriptive error message (e.g., from Ifthenpay or your backend validation)"
      // "ifthenpayResponse": { ... } // Optionally include Ifthenpay's error details
    }
    ```

## 2. Payment Status Callback

This endpoint is called by Ifthenpay to notify your backend about the status of a payment initiated via MB WAY. This URL needs to be configured in your Ifthenpay backoffice.

*   **URL:** `/api/ifthenpay/callback`
*   **Method:** `GET` (Ifthenpay typically uses GET for callbacks)
*   **Query Parameters (sent by Ifthenpay):**
    *   `mbwaykey`: Your Ifthenpay MB WAY Key (provided in the callback URL you set up).
    *   `orderid`: Your original `orderId`.
    *   `amount`: The payment `amount`.
    *   `status`: Payment status code from Ifthenpay (e.g., "1" for paid, "2" for refused, etc. - **verify these codes in Ifthenpay docs**).
    *   `refid`: Ifthenpay's transaction reference ID.
    *   `datetime`: Timestamp of the transaction (e.g., `yy-mm-dd hh:mm:ss`).
    *   `signature`: A signature generated by Ifthenpay to verify the authenticity of the callback.
*   **Backend Logic:**
    1.  **Security - Validate Callback Origin:**
        *   Retrieve your Ifthenpay Anti-Phishing Key (this should be stored securely as a server-side configuration/environment variable).
        *   Construct the string to be used for signature validation. According to Ifthenpay documentation, this is typically a concatenation of: `orderid`, `amount`, `refid`, and `datetime` (ensure the correct order and format as per Ifthenpay docs).
        *   Generate your own signature (e.g., using SHA256 HMAC) of this concatenated string using your Anti-Phishing Key.
        *   Compare your generated signature with the `signature` parameter received from Ifthenpay. **If they do not match, the callback is not genuine and should be ignored or logged as suspicious.**
    2.  **Process Payment Status:**
        *   If the signature is valid, find the transaction in your database using `orderid`.
        *   Update the transaction status based on the `status` parameter from Ifthenpay.
        *   If the payment is successful (e.g., `status === "1"`):
            *   Finalize the booking/order.
            *   Optionally, send a confirmation email to the client.
        *   If the payment failed or was refused, update the status accordingly.
    3.  **Respond to Ifthenpay:**
        *   Return an HTTP `200 OK` status to acknowledge receipt of the callback. Ifthenpay might retry if it doesn't receive a 200 OK. Avoid returning any sensitive data in the response body.

## Important Security Notes:

*   **Store Keys Securely:** Your Ifthenpay MB WAY Key and Anti-Phishing Key must be stored securely on the backend (e.g., environment variables, secrets management system) and never exposed to the frontend.
*   **Idempotency:** Design your callback handler to be idempotent. Ifthenpay might send the same callback multiple times. Ensure that processing the same callback again doesn't cause duplicate actions (e.g., crediting an order twice). Check the current status of the order before updating.
*   **Logging:** Implement comprehensive logging for both initiating payments and handling callbacks, especially for errors or suspicious activities.

This documentation should serve as a starting point for backend development. Refer to the official Ifthenpay API documentation for the most up-to-date and detailed specifications.
